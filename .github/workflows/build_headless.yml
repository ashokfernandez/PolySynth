name: Headless Validation + Demo Publish (Manual)

on:
  workflow_dispatch:

concurrency:
  group: pages-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright
  CCACHE_DIR: ~/.cache/ccache

jobs:
  full-headless-validation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Restore ccache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ccache
        key: ${{ runner.os }}-ccache-${{ github.workflow }}-${{ hashFiles('tests/CMakeLists.txt', 'libs/SEA_DSP/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-ccache-${{ github.workflow }}-

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build make python3 ccache

    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: latest

    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        node-version: 22
        cache: npm
        cache-dependency-path: tests/Visual/package-lock.json
        
    - name: Reset ccache stats
      run: ccache -z

    - name: Download External Deps
      run: |
        chmod +x scripts/download_dependencies.sh
        ./scripts/download_dependencies.sh

    - name: Ensure iPlug2 WAM dependencies
      run: |
        chmod +x scripts/download_iPlug2.sh
        ./scripts/download_iPlug2.sh
        
    - name: Configure and build native tests
      run: |
        cmake -S tests -B tests/build -G Ninja -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        cmake --build tests/build --parallel
        
    - name: Show ccache stats
      run: ccache -s

    - name: Run native tests
      run: ./tests/build/run_tests
        
    - name: Generate audio verification report
      run: |
        python3 scripts/generate_test_report.py

    - name: Install visual test dependencies (npm)
      working-directory: tests/Visual
      run: npm ci

    - name: Restore Playwright browser cache
      id: playwright-cache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-playwright-${{ hashFiles('tests/Visual/package-lock.json') }}

    - name: Install Playwright system dependencies (cache miss only)
      if: steps.playwright-cache.outputs.cache-hit != 'true'
      working-directory: tests/Visual
      run: npx playwright install --with-deps chromium

    - name: Ensure Playwright Chromium is available
      if: steps.playwright-cache.outputs.cache-hit == 'true'
      working-directory: tests/Visual
      run: npx playwright install chromium

    - name: Run component gallery visual test pipeline
      run: |
        chmod +x scripts/tasks/test_gallery_visual.sh
        ./scripts/tasks/test_gallery_visual.sh


    - name: Build PolySynth WAM web demo
      working-directory: src/platform/desktop
      run: |
        chmod +x scripts/makedist-web.sh
        ./scripts/makedist-web.sh off

    - name: Build Storybook static site
      working-directory: tests/Visual
      run: npm run build-storybook

    - name: Verify generated web demo bundle
      run: test -f src/platform/desktop/build-web/index.html

    - name: Upload Storybook static artifact
      uses: actions/upload-artifact@v4
      with:
        name: component-gallery-storybook-static
        path: tests/Visual/storybook-static
        if-no-files-found: error

    - name: Stage web demo and Storybook into docs/
      run: |
        rm -rf docs/web-demo docs/component-gallery
        mkdir -p docs/web-demo docs/component-gallery
        cp -R src/platform/desktop/build-web/. docs/web-demo/
        cp -R tests/Visual/storybook-static/. docs/component-gallery/
        touch docs/.nojekyll

    - name: Deploy staged docs to gh-pages
      if: github.ref == 'refs/heads/main'
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: docs
        branch: gh-pages
