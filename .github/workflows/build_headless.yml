name: Headless Validation + Demo Publish (Manual)

on:
  workflow_dispatch:

concurrency:
  group: pages-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CCACHE_DIR: ~/.cache/ccache

jobs:
  full-headless-validation:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Restore ccache
      uses: actions/cache@v4
      with:
        path: ~/.cache/ccache
        key: ${{ runner.os }}-ccache-${{ github.workflow }}-${{ hashFiles('tests/CMakeLists.txt', 'libs/SEA_DSP/CMakeLists.txt') }}
        restore-keys: |
          ${{ runner.os }}-ccache-${{ github.workflow }}-

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build make python3 ccache

    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: latest

    - name: Reset ccache stats
      run: ccache -z

    - name: Download External Deps
      run: |
        chmod +x scripts/download_dependencies.sh
        ./scripts/download_dependencies.sh

    - name: Ensure iPlug2 WAM dependencies
      run: |
        chmod +x scripts/download_iPlug2.sh
        ./scripts/download_iPlug2.sh

    - name: Configure and build native tests
      run: |
        cmake -S tests -B tests/build -G Ninja -DCMAKE_C_COMPILER_LAUNCHER=ccache -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        cmake --build tests/build --parallel

    - name: Show ccache stats
      run: ccache -s

    - name: Run native tests
      run: ./tests/build/run_tests

    - name: Generate audio verification report
      run: |
        python3 scripts/generate_test_report.py

    - name: Install xvfb and X11/GL dependencies
      run: |
        sudo apt-get install -y \
          xvfb libxcursor-dev libxrandr-dev libxinerama-dev \
          libxi-dev libgl1-mesa-dev python3-pip

    - name: Install Python VRT dependencies
      run: pip install -r scripts/requirements-vrt.txt

    - name: Build PolySynthGallery sandbox
      run: |
        cmake -S ComponentGallery -B ComponentGallery/build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_C_COMPILER_LAUNCHER=ccache \
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
        cmake --build ComponentGallery/build --parallel $(nproc)

    - name: Run VRT under xvfb
      run: |
        xvfb-run --auto-servernum --server-args="-screen 0 1024x768x24" \
          bash scripts/tasks/run_vrt.sh --verify

    - name: Build PolySynth WAM web demo
      working-directory: src/platform/desktop
      run: |
        chmod +x scripts/makedist-web.sh
        ./scripts/makedist-web.sh off

    - name: Verify generated web demo bundle
      run: test -f src/platform/desktop/build-web/index.html

    - name: Stage web demo into docs/
      run: |
        rm -rf docs/web-demo
        mkdir -p docs/web-demo
        cp -R src/platform/desktop/build-web/. docs/web-demo/
        touch docs/.nojekyll

    - name: Deploy staged docs to gh-pages
      if: github.ref == 'refs/heads/main'
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        folder: docs
        branch: gh-pages
