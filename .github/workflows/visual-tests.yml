name: PR Visual Regression

on:
  pull_request:

env:
  CCACHE_DIR: ~/.cache/ccache

jobs:
  native-visual-regression:
    name: Native Visual Regression
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install C++ build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build ccache python3-pip

      - name: Install xvfb and X11/GL dependencies
        run: |
          sudo apt-get install -y \
            xvfb \
            libxcursor-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxi-dev \
            libgl1-mesa-dev

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ${{ runner.os }}-ccache-sandbox-${{ hashFiles('ComponentGallery/CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-ccache-sandbox-

      - name: Download project external dependencies
        run: |
          chmod +x scripts/download_dependencies.sh
          ./scripts/download_dependencies.sh

      - name: Install Python VRT dependencies
        run: pip install -r scripts/requirements-vrt.txt

      - name: Build PolySynthGallery sandbox
        run: |
          cmake -S ComponentGallery -B ComponentGallery/build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
          cmake --build ComponentGallery/build --parallel $(nproc)

      - name: Run VRT under xvfb
        run: |
          xvfb-run --auto-servernum --server-args="-screen 0 1024x768x24" \
            bash scripts/tasks/run_vrt.sh --verify

      - name: Upload diff artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: vrt-diff-reports
          path: tests/Visual/output/
          if-no-files-found: ignore

      - name: Show ccache stats
        if: always()
        run: ccache -s
