<!doctype html>
<html lang="en-us">

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>PolySynth WAM</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Audiowide&family=Roboto:wght@400;700&display=swap"
    rel="stylesheet">

  <link href="styles/style.css" rel="stylesheet" type="text/css" />

  <script src="scripts/audioworklet.js"></script>
  <script>
    var statusElement = null;
    var progressElement = null;

    var Module = {
      printErr: function (text) { console.error('stderr: ' + text) },
      preRun: [],
      postRun: function () {
        document.getElementById('startWebAudioButton').removeAttribute("disabled");
        document.getElementById('status').textContent = 'Ready';
        setTimeout(() => {
          document.getElementById('greyout').classList.add('hidden');
        }, 500);
      },
      onRuntimeInitialized: function () {
        console.log("Runtime initialized");
      },
      setStatus: function (text) {
        if (!statusElement) statusElement = document.getElementById('status');
        if (statusElement) statusElement.innerHTML = text;
      },
      totalDependencies: 0,
      monitorRunDependencies: function (left) {
        this.totalDependencies = Math.max(this.totalDependencies, left);
        Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies - left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
      }
    };
    window.onerror = function (event) {
      Module.setStatus('Error loading engine.');
    };
  </script>
</head>

<body>
  <div id="main-container">

    <!-- Loading Overlay -->
    <div id="greyout">
      <div id="status">Warming up...</div>
    </div>

    <!-- Pre-Audio Landing -->
    <div id="buttons">
      <div
        style="font-family: 'Audiowide'; font-size: 2.25rem; color: #fff; margin-bottom: 32px; letter-spacing: -1px;">
        PolySynth</div>
      <button type="button" id="startWebAudioButton" onclick="startWebAudio()" disabled>Power On</button>
      <div id="midi-info">Detecting MIDI devices...</div>
    </div>

    <!-- Active Plugin Canvas -->
    <div id="wam" hidden=true>
      <canvas class="pluginArea" id="canvas" width="1024" height="768" oncontextmenu="event.preventDefault()"></canvas>
    </div>

  </div>

  <script type='text/javascript'>
    statusElement = document.getElementById('status');
    Module.canvas = document.getElementById('canvas');
    Module.canvas.addEventListener("webglcontextlost", function (e) {
      alert('WebGL context lost. Reloading.');
      location.reload();
    }, false);

    var PolySynth_WAM;

    // MIDI Discovery
    function checkMidi() {
      const info = document.getElementById('midi-info');
      if (navigator.requestMIDIAccess) {
        navigator.requestMIDIAccess().then(midi => {
          const inputs = [...midi.inputs.values()];
          if (inputs.length > 0) {
            info.innerHTML = `Ready with <span style="color:#fff">${inputs[0].name}</span>`;
          } else {
            info.textContent = "Keyboard not detected. Use mouse/keys to play.";
          }
        }).catch(() => {
          info.textContent = "MIDI access disabled.";
        });
      } else {
        info.textContent = "MIDI not supported in this browser.";
      }
    }
    checkMidi();

    function safariUnlock(audioCtx) {
      if (audioCtx.state !== 'suspended') return;
      const b = document.body;
      const events = ['touchstart', 'touchend', 'mousedown', 'keydown'];
      events.forEach(e => b.addEventListener(e, unlock, false));
      function unlock() { audioCtx.resume().then(clean); }
      function clean() { events.forEach(e => b.removeEventListener(e, unlock)); }
    }

    function connectionsDone() {
      document.getElementById('buttons').style.display = 'none';
      document.getElementById('wam').hidden = false;
      document.getElementById('wam').style.opacity = "1";
    }

    function startWebAudio() {
      // Create audio context on user gesture
      var actx = new (window.AudioContext || window.webkitAudioContext)();
      safariUnlock(actx);

      document.getElementById('startWebAudioButton').disabled = true;
      document.getElementById('startWebAudioButton').textContent = "Initializing...";

      AWPF.polyfill(actx).then(function () {
        var script1 = document.createElement("script");
        script1.src = "scripts/wam-controller.js";
        script1.onload = () => {
          var script2 = document.createElement("script");
          script2.src = "scripts/PolySynth-awn.js";
          script2.onload = () => {
            let inputBuses = [];
            let outputBuses = [2];
            let options = {
              numberOfInputs: inputBuses.length, inputChannelCount: inputBuses,
              numberOfOutputs: outputBuses.length, outputChannelCount: outputBuses,
              processorOptions: { inputChannelCount: inputBuses }
            };

            PolySynthController.importScripts(actx).then(() => {
              PolySynth_WAM = new PolySynthController(actx, options);
              if (PolySynth_WAM !== undefined) {
                PolySynth_WAM.connect(actx.destination);
                connectionsDone();
              }
            }).catch((e) => {
              console.error("PolySynthController failure:", e);
              document.getElementById('startWebAudioButton').textContent = "Error";
            });
          }
          document.head.appendChild(script2);
        }
        document.head.appendChild(script1);
      });
    }
  </script>
  <script src="scripts/PolySynth-web.js"></script>
</body>

</html>